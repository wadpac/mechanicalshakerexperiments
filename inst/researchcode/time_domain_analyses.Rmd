---
title: "Time domain analyses"
author: "Annelinde Lettink"
output: 
  html_notebook:
    toc: true
    toc_depth: 5 # upto four depths of headings (specified by #, ##, ###, #### and #####)
---

```{r Setup and load data, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(dev = 'pdf')

rm(list=ls())
graphics.off()

# Update to be your local directory, if all goes well this is the only line you will have to update
shaker_experiments_folder = "/Users/annelindelettink/Documents/Work MacBook Pro Annelinde/Mechanical Shaker Machine"
# shaker_experiments_folder = "~/data/VUMC/shaker_experiments"

#====================================================================================
# Specify file paths
datadir = paste0(shaker_experiments_folder, "/analyses/")
if (!dir.exists(datadir)) {
  stop(paste0("Directory does not exist: ", datadir))
}

# Load cleaned mechanical shaker machine data for both experiments
filename_high = paste0(datadir, "ms_flat_HA_cleaned_high.RData") 
filename_low = paste0(datadir, "ms_flat_HA_cleaned_low.RData") 
if (!file.exists(filename_high)) {
  stop(paste0("File does not exist: ", filename_high))
}
load(filename_high)
if (!file.exists(filename_low)) {
  stop(paste0("File does not exist: ", filename_low))
}
load(filename_low)
rm(filename_high, filename_low)
```

```{r Functions, include=FALSE}
#' computeCrossCorrelations
#'
#' @description 'computeCrossCorrelations' computes the maximum cross-correlations between two signals and the corresponding lag
#' @param data An object of class "spec"
#' @return List object consisting of two elements: \item{correlationMatrix}{A correlation matrix representing the maximum cross-correlations between the signals} \item{lags}{A matrix that presents the lags corresponding to the lag in which the maximum cross-correlation occurred}
#' @export
computeCrossCorrelations <- function(data, plot) {
  correlationMatrix <- matrix(data=NA,nrow=length(data),ncol=length(data)) # create empty matrix for max cross-correlations
  lagMatrix <- matrix(data=NA,nrow=length(data),ncol=length(data)) # create empty matrix to save lags corresponding to max cross-correlations
  for (x in 1:length(data)) {
    for (y in 1:length(data)) {
      cat(paste0(y, "/",  x, "/", length(data), " "))
      if (x==y) {
        correlationMatrix[x,y] <- 1
        x = x + 1
      }
      else {
        #If one the time series during the shaker condition(s) has a standard deviation of 0, cross-correlation coefÃŸficient = 0
        if(sd(data[[x]]$HA) == 0 | sd(data[[y]]$HA) == 0){
          correlationMatrix[x,y] <- 0
          lagMatrix[x,y] <- NA
        }
        else{
          crossCorr <- ccf(data[[x]]$HA, data[[y]]$HA, type = "correlation", plot = plot)
          correlationMatrix[x,y] <- max(crossCorr$acf)
          lagMatrix[x,y] <- crossCorr$lag[crossCorr$acf==max(crossCorr$acf)]
        }
      }
    }
  }
  colnames(correlationMatrix) <- names(data)
  rownames(correlationMatrix) <- names(data)
  colnames(lagMatrix) <- names(data)
  rownames(lagMatrix) <- names(data)
  return(list(correlationMatrix = correlationMatrix, lags = lagMatrix))
}

#' computeCrossCorrelationsPerShakerCondition
#'
#' @description 'computeCrossCorrelationsPerShakerCondition' computes for each shaker condition the maximum cross-correlations between two signals and the corresponding lag per shaker condition using the function computeCrossCorrelations
#' @param data An object of class "spec"
#' @return List object containing the cross-correlations and lags for each shaker condition
#' @export
computeCrossCorrelationsPerShakerCondition <- function(data) {
  correlationList <- list()
  shakerCondition <- c(30, 40, 50, 62, 75, 87, 100, 112, 125, 137, 150, 160, 175, 187, 200, 212, 225, 237, 250)
  for(condition in 1:length(shakerCondition)){
    #Select data associated with the shaker condition
    selectData <- list()
    for(device in 1:length(data)){
      tmp <- subset(data[[device]], data[[device]]$shaking_frequency == shakerCondition[condition])
      selectData[[device]] <- tmp
    }
    names(selectData) <- names(data)
    correlationList[[condition]] <- computeCrossCorrelations(selectData, plot = TRUE)
  }
  names(correlationList) <- shakerCondition
  return(correlationList)
}

#' pairwisePlots
#'
#' @description 'pairwisePlots' generates a plot including two timeseries
#' @param correlationMatrix A matrix that indicates for which pairs plots need to be derived
#' @param data A list that includes the timeseries data
#' @param threshold A double number indicating the threshold cross-correlation for which pairwise plots will be generated
#' @return Plot including two time series the timeseries of the device first in the title is presented in black
#' @export
pairwisePlots <- function(correlationMatrix, data, threshold) {
  plot_list <- list()
  list_name <- c()
  counter = 0
  for (x in 1:nrow(correlationMatrix)){
    for (y in 1:ncol(correlationMatrix)){
      if (correlationMatrix[x,y] < 1 & !is.na(correlationMatrix[x,y])) {
        if(correlationMatrix[x,y] <= threshold){ #only create pairwise plots if the cross-correlation is equal/lower to the threshold
          counter = counter + 1
          device1 <- names(data)[[x]]
          device2 <- names(data)[[y]]
          file_name <- paste(paste(device1, device2, sep = "_vs_"), correlationMatrix[x,y], sep = " r = ")
        jpeg(paste(datadir, file_name, ".jpeg", sep = "/plots/"), width=600, height=500, res=120) 
        p <- ggplot2::ggplot() +
          ggplot2::geom_point(data = data[[x]], ggplot2::aes(x = time, y = HA, colour = "black"), 
                              alpha = 0.2, size = 0.25) +
          ggplot2::geom_point(data = data[[y]], ggplot2::aes(x = time, y = HA, colour = "red"), 
                              alpha =  0.2, size = 0.25) +
          ggplot2::theme_bw() +
          ggplot2::labs(title = paste0("Cross-correlation = ",  correlationMatrix[x,y]), y = "acceleration (g)") +
          #Legend
          ggplot2::scale_color_manual(values = c("black", "red"), labels=c(device1, device2)) +
          ggplot2::scale_fill_manual(name ="signal") + ggplot2::theme(legend.position = "right") 
        dev.off()
        plot_list[[counter]] <- p
        }
      }
    }
  }
  return(plot_list)
}

#' dataframeShapeComparisonBeween
#'
#' @description 'dataframeShapeComparisonBeween' derives a data.frame object required for between and within brand comparison of the cross-correlations
#'
#' @param crossCorrelations A list consisting of two elements: \item{correlationMatrix}{A correlation matrix representing the maximum cross-correlations between the signals} \item{lags}{A matrix that presents the lags corresponding to the lag in which the maximum cross-correlation occurred}
#' @param specifications A data.frame object that represents specifications of the signal, including serial_number and brand
#' @return A data.frame with the following variables: \item{correlation}{Representing the cross-correlations between the two signals}, \item{lag}{Representing the lag corresonding to the maximum correlation between the two signals} 
#' \item{brand1}{Representing the brand of the first signal}, \item{brand2}{Representing the brand of the second signal}, 
#' \item{device1}{Representing the serial number of the device that recorded the first signal}, \item{device2}{Representing the serial number of the device that recorded the second signal},
#' \item{same_brand}{An indicator of correlations that can be selected for the within (1) or between(0) brand comparison}
#' 
#' @export
#' 
dataframeShapeComparisonBeween <- function(crossCorrelations, specifications){
  correlation <- c()
  lag  <- c()
  device1 <- c()
  device2 <- c()
  brand1 <- c()
  brand2 <- c()
  for(row in 1:nrow(crossCorrelations$correlationMatrix)) {
    for(col in 1:ncol(crossCorrelations$correlationMatrix)) {
      if(!is.na(crossCorrelations$correlationMatrix[row, col]) & !(row == col)){
        correlation <- c(correlation, as.double(crossCorrelations$correlationMatrix[row, col]))
        lag  <- c(lag, crossCorrelations$lags[row, col])
        device1 <- c(device1, specifications$label[row])
        device2 <- c(device2, specifications$label[col])
        brand1 <- c(brand1, specifications$brand[row])
        brand2 <- c(brand2, specifications$brand[col])
      }
    }
  }
  df_correlations <- as.data.frame(cbind(correlation, lag, brand1, device1, brand2, device2))
  brands <- as.factor(paste0(brand1, brand2))
  
  same_brand <- c()
  for(i in 1:nrow(df_correlations)){
    if(df_correlations$brand1[i] == df_correlations$brand2[i]){
      same_brand <- c(same_brand, 1)
    } else{
      same_brand <- c(same_brand, 0)}
  }
  df_correlations <- cbind(df_correlations, same_brand, brands)
  return(as.data.frame(df_correlations))
}
```

# Cross-correlations
For the calculation of the cross-correlations, only data with equal sampling frequency were included. For the high sampling frequency experiment this sampling frequency was 100 Hz, and for the low frequency sampling experiment this was 25 Hz. This section presents the maximum lagged cross-correlations between all signal pairs for both experiments separately.

```{r Ensure data with equal sampling frequencies are selected for both experiments, include=FALSE}

# Cross-correlations are only calculated for the selected data as otherwise interpolation is required (this is not longer raw data and outside the scope of this paper)
data_high <- clean_data_high$timeDomain$data[as.numeric(clean_data_high$timeDomain$specifications$sampling_frequency) == "100"]
data_low <- clean_data_low$timeDomain$data[as.numeric(clean_data_low$timeDomain$specifications$sampling_frequency) == "25"]

specifications_high <- clean_data_high$timeDomain$specifications[as.numeric(clean_data_high$timeDomain$specifications$sampling_frequency) == "100",]
specifications_low <- clean_data_low$timeDomain$specifications[as.numeric(clean_data_low$timeDomain$specifications$sampling_frequency) == "25",]

rm(shaker_experiments_folder, clean_data_high, clean_data_low)
```

```{r Compute overall cross-correlation matrices, include = FALSE}
correlations_low <- computeCrossCorrelations(data_low, plot = TRUE) 
correlations_high <- computeCrossCorrelations(data_high, plot = TRUE)
```

```{r Compute cross-correlation matrices per shaker condition, include = FALSE}
correlations_low_perShakerCondition <- computeCrossCorrelationsPerShakerCondition(data_low) 
correlations_high_perShakerCondition <- computeCrossCorrelationsPerShakerCondition(data_high)
```

```{r Save cross-correlation matrices, include = FALSE}
#cat("\nSaving data...")
correlation_matrices <- list(low = correlations_low, high = correlations_high)
save(correlation_matrices, file = paste0(datadir, "cross_correlations_overall.RData"))
correlation_matrices <- list(low = correlations_low_perShakerCondition, high = correlations_high_perShakerCondition)
save(correlation_matrices, file = paste0(datadir, "cross_correlations_perShakerCondition.RData"))
rm(correlations_low, correlations_high, correlations_low_perShakerCondition, correlations_high_perShakerCondition)

#load(paste0(datadir, "cross_correlations_overall.RData"))
```

## Low sampling frequency experiment

### Heatmap
```{r Heatmap low frequency experiment, echo=FALSE, fig.width=14, fig.height=14}
fullmatrix_low <- correlation_matrices$low$correlationMatrix
heatmap_low <- corrplot::corrplot(pmax(fullmatrix_low, t(fullmatrix_low), na.rm = TRUE), 
                                  type = 'lower', method = 'color', order = "alphabet", 
                                  number.cex = 1.25, cl.cex = 2, tl.cex = 2,
                                  col.lim = c(0,1), addCoef.col = 'black', tl.srt = 45, 
                                  diag = TRUE, tl.col = "black")
rm(fullmatrix_low, heatmap_low)
```

### Pairwise signal plots
In this section pairwise plots are generated for cross-correlations that are 1 SD lower than the mean cross-correlation (i.e., threshold).

#### Descriptive statistics

```{r Summary statistics low frequency experiment, echo=FALSE}
# cross-correlations
M <- mean(correlation_matrices$low$correlationMatrix, na.rm = TRUE)
SD <- sd(correlation_matrices$low$correlationMatrix, na.rm = TRUE)
Q1 <- quantile(correlation_matrices$low$correlationMatrix, na.rm = TRUE)[2]
Median <- median(correlation_matrices$low$correlationMatrix, na.rm = TRUE)
Q3 <- quantile(correlation_matrices$low$correlationMatrix, na.rm = TRUE)[4]
crosscorr_low_threshold <- M - SD
cross_correlations <- c(M, SD, Q1, Median, Q3, crosscorr_low_threshold)

# lags
M <- mean(correlation_matrices$low$lags, na.rm = TRUE)
SD <- sd(correlation_matrices$low$lags, na.rm = TRUE)
Q1 <- quantile(correlation_matrices$low$lags, na.rm = TRUE)[2]
Median <- median(correlation_matrices$low$lags, na.rm = TRUE)
Q3 <- quantile(correlation_matrices$low$lags, na.rm = TRUE)[4]
low_threshold <- NA
lags <- c(M, SD, Q1, Median, Q3, low_threshold)

tab <- rbind(cross_correlations, lags)
colnames(tab) <- c("M", "SD", "Q1", "Median", "Q3", "threshold")
tab
rm(tab, M, SD, Q1, Median, Q3, low_threshold)
```

```{r Low Frequency Experiment: Pairwise plots, include=FALSE}
plots_low <- pairwisePlots(correlationMatrix = correlation_matrices$low$correlationMatrix, 
                           data = data_low, threshold = crosscorr_low_threshold)
```

#### Pairwise plots
```{r Print pairwise plots: low sampling experiment, echo=FALSE}
for(plot in 1:length(plots_low)){
  print(plots_low[[plot]])
}
```

## High sampling frequency experiment

### Heatmaps
This section presents the heatmaps for all devices and per brand.

```{r Heatmap high sampling frequency experiment, echo=FALSE, , out.extra='angle=90', fig.width=14, fig.height=14}
fullmatrix_high <- correlation_matrices$high$correlationMatrix
heatmap_high <- corrplot::corrplot(pmax(fullmatrix_high, t(fullmatrix_high), na.rm = TRUE), 
                                   type = 'lower', method = 'color', order = "alphabet",
                                   number.cex = 1.25, cl.cex = 2, tl.cex = 2,
                                   col.lim = c(0,1), addCoef.col = 'black', tl.srt=45, diag = TRUE, 
                                   tl.col = "black")
```

#### ActiGraph
```{r Heatmap high sampling frequency experiment, echo=FALSE, , out.extra='angle=90', fig.width=14, fig.height=14}
matrix_high_AG <- correlation_matrices$high$correlationMatrix[grep("AG",rownames(correlation_matrices$high$correlationMatrix)), grep("AG", colnames(correlation_matrices$high$correlationMatrix))] 
heatmap_high_AG <- corrplot::corrplot(pmax(matrix_high_AG, t(matrix_high_AG), na.rm = TRUE), 
                                      type = 'lower', method = 'color', order = "alphabet",
                                      number.cex = 1.25, cl.cex = 2, tl.cex = 2,
                                      col.lim = c(0,1), addCoef.col = 'black', tl.srt=45, diag = TRUE, 
                                      tl.col = "black")
```

#### Axivity
```{r Heatmap high sampling frequency experiment, echo=FALSE, , out.extra='angle=90', fig.width=14, fig.height=14}
matrix_high_Ax <- correlation_matrices$high$correlationMatrix[grep("Ax",rownames(correlation_matrices$high$correlationMatrix)), grep("Ax", colnames(correlation_matrices$high$correlationMatrix))] 
heatmap_high_Ax <- corrplot::corrplot(pmax(matrix_high_Ax, t(matrix_high_Ax), na.rm = TRUE), 
                                      type = 'lower', method = 'color', order = "alphabet",
                                      number.cex = 1.25, cl.cex = 2, tl.cex = 2,
                                      col.lim = c(0,1), addCoef.col = 'black', tl.srt=45, diag = TRUE, 
                                      tl.col = "black")
```

#### GENEActiv
```{r Heatmap high sampling frequency experiment, echo=FALSE, , out.extra='angle=90', fig.width=14, fig.height=14}
matrix_high_GA <- correlation_matrices$high$correlationMatrix[grep("GA",rownames(correlation_matrices$high$correlationMatrix)), grep("GA", colnames(correlation_matrices$high$correlationMatrix))] 
heatmap_high_GA <- corrplot::corrplot(pmax(matrix_high_GA, t(matrix_high_GA), na.rm = TRUE), 
                                      type = 'lower', method = 'color', order = "alphabet",
                                      number.cex = 1.25, cl.cex = 2, tl.cex = 2,
                                      col.lim = c(0,1), addCoef.col = 'black', tl.srt=45, diag = TRUE, 
                                      tl.col = "black")
```

### Pairwise signal plots
In this section pairwise plots are generated for cross-correlations that are 1 SD lower than the mean cross-correlation (i.e., threshold).

#### Descriptive statistics

```{r Summary statistics high sampling frequency experiment, echo=FALSE}
# cross-correlations
M <- mean(correlation_matrices$high$correlationMatrix, na.rm = TRUE)
SD <- sd(correlation_matrices$high$correlationMatrix, na.rm = TRUE)
Q1 <- quantile(correlation_matrices$high$correlationMatrix, na.rm = TRUE)[2]
Median <- median(correlation_matrices$high$correlationMatrix, na.rm = TRUE)
Q3 <- quantile(correlation_matrices$high$correlationMatrix, na.rm = TRUE)[4]
crosscorr_high_threshold <- M - SD
cross_correlations <- c(M, SD, Q1, Median, Q3, crosscorr_high_threshold)

# lags
M <- mean(correlation_matrices$high$lags, na.rm = TRUE)
SD <- sd(correlation_matrices$high$lags, na.rm = TRUE)
Q1 <- quantile(correlation_matrices$high$lags, na.rm = TRUE)[2]
Median <- median(correlation_matrices$high$lags, na.rm = TRUE)
Q3 <- quantile(correlation_matrices$high$lags, na.rm = TRUE)[4]
threshold_high <- NA
lags <- c(M, SD, Q1, Median, Q3, threshold_high)

tab <- rbind(cross_correlations, lags)
colnames(tab) <- c("M", "SD", "Q1", "Median", "Q3", "threshold")
tab
rm(tab, M, SD, Q1, Median, Q3, threshold_high)
```

```{r High Sampling Frequency Experiment: Pairwise plots, include=FALSE}
plots_high <- pairwisePlots(correlationMatrix = correlation_matrices$high$correlationMatrix, 
                            data = data_high, threshold = crosscorr_high_threshold)
```

#### Pairwise plots
```{r Print pairwise plots: high sampling experiment, echo=FALSE}
for(plot in 1:length(plots_high)){
  print(plots_high[[plot]])
}
```

# Between brand comparison
In this section the average maximum lagged cross-correlation between the pair brands are presented separately for both experiments.

## Descriptive statistics
```{r  Derive data.frames required for comparison of the signal shape between brands, include=FALSE}
df_correlations_low <- dataframeShapeComparisonBeween(correlation_matrices$low, specifications_low) 
df_correlations_high <- dataframeShapeComparisonBeween(correlation_matrices$high, specifications_high) 

cat("\nSaving data...")
correlation_df <- list(low = df_correlations_low, high = df_correlations_high)
save(correlation_df, file = paste0(datadir, "cross_correlation_df.RData"))

#Subset the data to include only between brand comparisons
correlations_between_low <- correlation_df$low[correlation_df$low$same_brand =="0", ]
correlations_between_high <- correlation_df$high[correlation_df$high$same_brand =="0", ]
```

### Low sampling frequency experiment
```{r Descriptives low sampling frequency experiment, echo=FALSE}
library(dplyr)
correlations_between_low$correlation <- as.numeric(correlations_between_low$correlation)
#table_between_low <- correlations_between_low %>% group_by(brands)
avg_cor <- tapply(correlations_between_low$correlation, correlations_between_low$brands, summary)

tab <- rbind(avg_cor$GENEActivAxivity, avg_cor$MOXAxivity, avg_cor$MOXGENEActiv)
tab <- tab[,-1]
tab <- tab[,-5]

SD <- tapply(correlations_between_low$correlation, correlations_between_low$brands, sd)
SD <- c(SD[2], SD[4], SD[5])
tab <- cbind(tab, SD)
tab
```

### High sampling frequency experiment
During the high sampling frequency experiment ActiGraph IDLE sleep mode accidentally turned on in nine devices. We therefore decided to report the cross-correlation for this experiment with and without these devices.

#### Including ActiGraphs with IDLE sleep mode
```{r Descriptives high sampling frequency experiment incl IDLE, echo=FALSE}
library(dplyr)
correlations_between_high$correlation <- as.numeric(correlations_between_high$correlation)
# table_between_high <- correlations_between_high %>% group_by(brands)
avg_cor <- tapply(correlations_between_high$correlation, correlations_between_high$brands, summary)
SD <- tapply(correlations_between_high$correlation, correlations_between_high$brands, sd)

tab <- rbind(avg_cor$AxivityActigraph, avg_cor$GENEActivActigraph, avg_cor$GENEActivAxivity)
rownames(tab) <- c("AxivityActigraph", "GENEActivActigraph", "GENEActivAxivity")
tab <- tab[,-1]
tab <- tab[,-5]

SD <- c(SD[2], SD[4], SD[5])
tab <- cbind(tab, SD)
tab
```

#### Excluding ActiGraphs with IDLE sleep mode
```{r Descriptives high sampling frequency experiment ActiGraph excl IDLE mode, echo=FALSE}
IDLE_on <- c("AG_CLE_039", "AG_CLE_077", "AG_CLE_091", "AG_CLE_132", "AG_MOS_028", 
             "AG_MOS_192", "AG_MOS_352", "AG_MOS_527", "AG_MOS_008") #

correlation_df_exclIDLE <- correlation_df$high[!correlation_df$high$device1 %in% IDLE_on,]
correlation_df_exclIDLE <- correlation_df_exclIDLE[!correlation_df_exclIDLE$device2 %in% IDLE_on,]

correlations_between_high_exclIDLE <- correlation_df_exclIDLE[correlation_df_exclIDLE$same_brand =="0", ]

correlations_between_high_exclIDLE$correlation <- as.numeric(correlations_between_high_exclIDLE$correlation)
avg_cor <- tapply(correlations_between_high_exclIDLE$correlation, correlations_between_high_exclIDLE$brands, summary)
SD <- tapply(correlations_between_high_exclIDLE$correlation, correlations_between_high_exclIDLE$brands, sd)

tab <- rbind(avg_cor$AxivityActigraph, avg_cor$GENEActivActigraph, avg_cor$GENEActivAxivity)
rownames(tab) <- c("AxivityActigraph", "GENEActivActigraph", "GENEActivAxivity")
tab <- tab[,-1]
tab <- tab[,-5]

SD <- c(SD[2], SD[4], SD[5])
tab <- cbind(tab, SD)
tab

```

