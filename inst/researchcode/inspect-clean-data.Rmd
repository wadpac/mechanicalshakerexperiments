---
title: "Inspect and clean data"
author: "Annelinde Lettink"
output: 
  html_notebook:
    toc: true
    toc_depth: 4 # upto four depths of headings (specified by #, ##, ###, and ####)
---

This file describes how the the required raw data (horizontal axis; x-axis) was cleaned to make a standardised comparison using the exact same time segments.

For each sensor brand considered in the comparison movement exposure needs to be identical, otherwise this would invalidate the comparison of the frequency spectra and cross-correlations.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
graphics.off()
#==============================================================================
# Specify file paths and load data
shaker_experiments_folder = "/Users/annelindelettink/Documents/Work MacBook Pro Annelinde/Mechanical Shaker Machine"
datadir = paste0(shaker_experiments_folder, "/analyses/")
if (!dir.exists(datadir)) {
  stop(paste0("Directory does not exist: ", datadir))
}
# Load mechanical shaker data for horizontal axis
filename_flatHA = paste0(datadir, "ms_flat_HA.RData") 
if (!file.exists(filename_flatHA)) {
  stop(paste0("File does not exist: ", filename_flatHA))
}
load(filename_flatHA)
```

```{r Exclude activPAL data from high sampling frequency experiment, include = FALSE}
index <- which(ms_flat_HA$specifications$brand == "Activpal" & ms_flat_HA$specifications$experiment == "ms_hfcr")
specifications <- ms_flat_HA$specifications[-index,]
data <- ms_flat_HA$data
data[index] <- NULL
ms_flat_HA_aP_excluded <- list(data = data, specifications = specifications)
rm(index, data, specifications, ms_flat_HA)
```


```{r Functions, include=FALSE}
#' plotSignals
#'
#' @description 'plotSignals' plots the signals in the dataset
#'
#' @param directory A string that indicates the file path of the analyses folder
#' @param data List of two elements: \item{data}{A list of data.frame objects, each representing accelerometer time series, including the columns shaking_frequency, time and HA} 
#' \item{specifications}{A data.frame where each row contains the specifications of the associated acccelerometer file}
#' @return A list with the signal plots
#' 
#' @export
#' 
plotSignals <- function(directory, data){
  plot_list <- list()
  for(signal in 1:length(data)) {
    file_name <- paste0("time series: ", names(data)[signal])
    jpeg(paste(directory, paste0(file_name, ".jpeg"), sep = "plots/"), width=600, height=500, res=120) 
    p <- ggplot2::ggplot() +
      ggplot2::geom_point(data = data[[signal]], ggplot2::aes(x = time, y = HA), 
                        alpha = 0.2, size = 0.25) +
      ggplot2::theme_bw() +
      ggplot2::labs(title = file_name, y = "acceleration (g)") 
    dev.off()
    plot_list[[signal]] <- p
  }
  return(plot_list)
}
#' cleanSignals
#'
#' @description 'cleanSignals' cleans signal by removing data for which the shaking frequency was null, the experiment was stopped, or measurements were repeated
#' #'
#' @param data List of two elements: \item{data}{A list of data.frame objects each representing accelerometer time series, including the columns shaking_frequency, time and HA} 
#' \item{specifications}{A data.frame where each row contains the specifications of the associated acccelerometer file}
#' @return The data list with the element data now containing the cleaned signals
#' 
#' @export
#' 
cleanSignals <- function(data) {
  cleaned_signals <- list()
  
  for(file in 1:length(data$data)){
    signal <- data$data[[file]]
    #Step 1: Remove data on which the experiment was stopped (shaking frequency 0 and -1), otherwise noise around 0 Hz will be correlated with noise around 0 Hz
    cleaned_signal <- signal[which(signal$shaking_frequency != "0" & signal$shaking_frequency != "-1"),]
    
    #Step 2: If the experiment is the high sampling frequency experiment, remove the double data due to repeating the experiment.
    if(data$specifications$experiment[[file]] == "ms_hfcr"){
      tz = "Europe/Amsterdam"
      #Remove data where accelerometers_used in description-file was all_except_one_GENEActiv
      start1 <- as.POSIXlt("2020-11-24 9:42:00", tz = tz)
      end1 <- as.POSIXlt("2020-11-24 10:13:00", tz = tz)
      start2 <- as.POSIXlt("2020-11-24 10:35:05", tz = tz)
      end2 <- as.POSIXlt("2020-11-24 10:47:00", tz = tz)
      cleaned_signala <- cleaned_signal[which(cleaned_signal$time >= start1 & cleaned_signal$time <= end1),]
      cleaned_signalb <- cleaned_signal[which(cleaned_signal$time >= start2 & cleaned_signal$time <= end2),]
      cleaned_signal <- rbind(cleaned_signala, cleaned_signalb)
    }
    cleaned_signals[[file]] <- cleaned_signal
  }
  names(cleaned_signals) <- names(data$data)
  return(list(data = cleaned_signals , specifications = data$specifications))
}
#' calculateStartEnd
#'
#' @description 'calculateStartEnd' saves the start and end timestamp of a signal 
#' #'
#' @param data List for which each element represents a device. Each list element consists of the columns shaking_frequency, time and HA 
#' @return Data list with two vectors \item{start}{indicating the start time of the signals} \item{end}{indicating the end time of the signals}
#' 
#' @export
#' 
calculateStartEnd <- function(data){
  start <- c(data[[1]]$time[1])
  end <- c(data[[1]]$time[length(data[[1]]$time)])
  for (file in 2:length(data)) {
    start <- c(start, data[[file]]$time[1])
    end <- c(end, data[[file]]$time[length(data[[file]]$time)])
  }
  return(list(start = start, end = end))
}
#' checkStartEnd
#'
#' @description 'calculateStartEnd' calculates all pairwise differences (using calculateStartEnd) between signals and if the difference is higher than a certain threshold, the device labels are saved
#' #'
#' @param data List for which each element represents a device. Each list element consists of the columns shaking_frequency, time and HA 
#' @param threshold A number that indicates how big the absolute difference can be
#' @param unit One of: c("auto", "secs", "mins", "hours", "days", "weeks") to indicate the difference unit
#' @return Data list with four elements \item{diff_start}{A matrix indicating all pair-wise absolute start timestamp differences of the chosen unit} 
#' \item{diff_end}{A matrix indicating all pair-wise absolute end timestamp differences of the chosen unit}
#' \item{names_start}{The label(s) of the devices that are deviating with more than the threshold in the chosen unit, names_start = NA if there are no devices that meet the condition}
#' \item{names_end}{The label(s) of the devices that are deviating with more than the threshold in the chosen unit, names_end = NA if there are no devices that meet the condition}
#' 
#' @export
#' 
checkStartEnd <- function(data, threshold, unit = c("auto", "secs", "mins", "hours",
                                                    "days", "weeks")) {
  startend <- calculateStartEnd(data)   #Save the start and end times for the devices
  
  # Calculate the absolute differences for the all signals' start and end times
  diff_start <- matrix(data=NA,nrow=length(startend$start),ncol=length(startend$start))
  diff_end <- matrix(data=NA,nrow=length(startend$end),ncol=length(startend$end))
  for (x in 1:length(startend$start)) {
    for (y in 1:length(startend$start)) {
      if (x==y) {
        diff_start[x,y] <- 0
        diff_end[x,y] <- 0
        x = x + 1
        }
      else {
        diff_start[x,y] <- abs(difftime(startend$start[x], startend$start[y], tz, units = unit))
        diff_end[x,y] <- abs(difftime(startend$end[x], startend$end[y], tz, units = unit))
      }
    }
  }
  row.names(diff_start) <- names(data)
  colnames(diff_start) <- names(data)
  row.names(diff_end) <- names(data)
  colnames(diff_end) <- names(data)
  #If the difference of the start and end times is bigger than a certain threshold, indicate which devices this applies to
  index_start <- which(diff_start > threshold, arr.ind = T)
  names_start <- NA
  if (length(index_start) > 0) {
    names_start <- names(data)[unique(index_start[,1])]
  }
  index_end <- which(diff_end > threshold, arr.ind = T)
  names_end <- NA
  if(length(index_end) > 0){
    names_end <- names(data)[unique(index_end[,1])]
  }
  return(list(diff_start = diff_start, diff_end = diff_end, names_start = names_start, names_end = names_end))
}
```

# Visual data inspection
In this section the raw time series data is plotted and inspected.

## Signal plots
```{r Signal plots, include = FALSE}
# Save a plot for each signal
plot_list <- plotSignals(datadir, ms_flat_HA_aP_excluded$data)
rm(filename_flatHA)
```

```{r Plot signals, echo = FALSE}
# Save a plot for each signal
for(plot in 1:length(plot_list)){
  print(plot_list[[plot]])
}
rm(plot, plot_list)
```

## Descriptive statistics deviating signals
Visual inspection of the time series plots showed clear signal deviations for the following devices: aP_490, aP_254 and Ax_406.
This table presents the descriptive information of the deviating devices.

```{r Descriptive data of deviating signals, echo=FALSE}
deviates <- which(names(ms_flat_HA_aP_excluded$data) %in% c("aP_490", "aP_254", "Ax_406"))
M <- c()
SD <- c()
min <- c()
max <- c()
experiment <- c()
for (deviation in 1:length(deviates)){
  M <- c(M, mean(ms_flat_HA_aP_excluded$data[[deviates[[deviation]]]]$HA))
  SD <- c(SD, sd(ms_flat_HA_aP_excluded$data[[deviates[[deviation]]]]$HA))
  min <- c(min, min(ms_flat_HA_aP_excluded$data[[deviates[[deviation]]]]$HA))
  max <- c(max, max(ms_flat_HA_aP_excluded$data[[deviates[[deviation]]]]$HA))
  experiment <- c(experiment, ms_flat_HA_aP_excluded$specifications$experiment[deviates[deviation]])
}
tab <- cbind(experiment, M, SD, min, max)
rownames(tab) <- names(ms_flat_HA_aP_excluded$data[deviates])
tab
rm(deviation, M, SD, min, max, tab, experiment)
```

Deviating signals are removed and excluded from further analyses.

```{r Remove deviating signals and save data, include=FALSE}
ms_flat_HA_aP_excluded$data[deviates] <- NULL
ms_flat_HA_aP_excluded$specifications <- ms_flat_HA_aP_excluded$specifications[-deviates,]
cat("\nSaving data...")
save(ms_flat_HA_aP_excluded, file = paste0(datadir, "ms_flat_HA_deviates_removed.RData"))
rm(deviates)
```

# Cleaning the data
Remove the data for which the shaking frequency was null in order to avoid comparison of the signal noise. In addition we removed repeated measurements for some of the shaking frequencies because a device got loose during the high sampling frequency experiment.

```{r Clean the signals, include = FALSE}
data_cleaned <- cleanSignals(ms_flat_HA_aP_excluded)
rm(ms_flat_HA_aP_excluded)
```

## Cleaned signals
```{r Visual data inspection, include = FALSE}
# Save a plot for each signal
plots_clean <- plotSignals(datadir, data_cleaned$data)
```

```{r Plot all signals, echo = FALSE}
# Save a plot for each signal
for(plot in 1:length(plots_clean)){
  print(plots_clean[[plot]])
}
rm(plot, plots_clean)
```

## Amount of data
To ensure a fair comparison of the signals we checked if the recorded signals consisted of (approximately) equal minutes and seconds of data. Differences in fractions of seconds are understandable because the sampling rate of the devices was not identical.

### Low sampling frequency experiment
The start and end times of the signals did not differ with more than 1 second. 

```{r Start and end time low sampling frequency experiment, include=FALSE}
data_low <- data_cleaned$data[data_cleaned$specifications$experiment == "ms_lfcr"]
specifications_low <- data_cleaned$specifications[data_cleaned$specifications$experiment == "ms_lfcr", ]
check_low <- checkStartEnd(data_low, threshold = 1, unit = "sec") #there are no devices for which the start or end times differ with more than 1 sec
clean_data_low <- list(data = data_low, specifications = specifications_low)
rm(data_low, specifications_low)
```
#### Absolute start time differences (in seconds)
```{r Low sampling experiment start times, echo=FALSE}
print(as.data.frame(check_low$diff_start))
```

#### Absolute end time differences (in seconds)
```{r Low sampling experiment end times, echo=FALSE}
print(as.data.frame(check_low$diff_end))
rm(check_low)
```

### High sampling frequency experiment
The start did not differ with more than 1 second, however, for MOX devices the end time difference was 31.99984 minutes. These devices quit recording earlier than the other devices, therefore, data of these four devices were excluded from further analyses.

```{r Start and end time high sampling frequency experiment, include=FALSE}
data_high <- data_cleaned$data[data_cleaned$specifications$experiment == "ms_hfcr"]
specifications_high <- data_cleaned$specifications[data_cleaned$specifications$experiment == "ms_hfcr", ]
check_high <- checkStartEnd(data_high, threshold = 1, unit = "sec") 
print(as.data.frame(check_high$diff_end))
# For MOX devices, the time difference was 31.99984 mins
data_high[check_high$names_end] <- NULL # All MOX devices quit early, so leave them out the high sampling frequency experiment comparisons
specifications_high <- specifications_high[!specifications_high$label %in% check_high$names_end ,]
clean_data_high <- list(data = data_high, specifications = specifications_high)
rm(data_high, specifications_high)
```

#### Absolute start time differences (in seconds)
```{r High sampling experiment start times, echo=FALSE}
print(as.data.frame(check_high$diff_start))
```

#### Absolute end time differences (in seconds)
```{r High sampling experiment end times, echo=FALSE}
print(as.data.frame(check_high$diff_end))
rm(check_high)
```

```{r Save the cleaned data, include=FALSE}
cat("\nSaving data...")
save(clean_data_high, file = paste0(datadir, "ms_flat_HA_cleaned_high.RData"))
save(clean_data_low, file = paste0(datadir, "ms_flat_HA_cleaned_low.RData"))
```